import { __assign, __awaiter, __generator, __makeTemplateObject, __spreadArray } from "tslib";
import { replaceImportAddresses } from "./template-replacer";
import { FlowRunScriptError, FlowRunTransactionError, FlowSealError } from "./errors";
export var runScript = function (fcl, params, addressMap) { return __awaiter(void 0, void 0, void 0, function () {
    var cadence, result, error_1;
    return __generator(this, function (_a) {
        switch (_a.label) {
            case 0:
                _a.trys.push([0, 3, , 4]);
                cadence = replaceImportAddresses(params.cadence, addressMap);
                return [4 /*yield*/, fcl.send([fcl.script(templateObject_1 || (templateObject_1 = __makeTemplateObject(["", ""], ["", ""])), cadence), params.args])];
            case 1:
                result = _a.sent();
                return [4 /*yield*/, fcl.decode(result)];
            case 2: return [2 /*return*/, _a.sent()];
            case 3:
                error_1 = _a.sent();
                throw new FlowRunScriptError({ error: error_1, params: params });
            case 4: return [2 /*return*/];
        }
    });
}); };
export var runTransaction = function (fcl_1, addressMap_1, params_1, signature_1) {
    var args_1 = [];
    for (var _i = 4; _i < arguments.length; _i++) {
        args_1[_i - 4] = arguments[_i];
    }
    return __awaiter(void 0, __spreadArray([fcl_1, addressMap_1, params_1, signature_1], args_1, true), void 0, function (fcl, addressMap, params, signature, gasLimit) {
        var code, ix, tx, error_2;
        if (gasLimit === void 0) { gasLimit = 999; }
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    _a.trys.push([0, 2, , 3]);
                    code = replaceImportAddresses(params.cadence, addressMap);
                    ix = [fcl.limit(gasLimit)];
                    ix.push(fcl.payer(signature || fcl.authz), fcl.proposer(signature || fcl.authz), fcl.authorizations([signature || fcl.authz]));
                    if (params.args) {
                        ix.push(params.args);
                    }
                    ix.push(fcl.transaction(code));
                    return [4 /*yield*/, fcl.send(ix)];
                case 1:
                    tx = _a.sent();
                    return [2 /*return*/, tx.transactionId];
                case 2:
                    error_2 = _a.sent();
                    throw new FlowRunTransactionError({ error: error_2, params: params });
                case 3: return [2 /*return*/];
            }
        });
    });
};
export var waitForSeal = function (fcl, txId) { return __awaiter(void 0, void 0, void 0, function () {
    var sealed, error_3;
    return __generator(this, function (_a) {
        switch (_a.label) {
            case 0:
                _a.trys.push([0, 2, , 3]);
                return [4 /*yield*/, fcl.tx(txId).onceSealed()];
            case 1:
                sealed = _a.sent();
                return [2 /*return*/, __assign(__assign({}, sealed), { txId: txId })];
            case 2:
                error_3 = _a.sent();
                throw new FlowSealError({ error: error_3, txId: txId });
            case 3: return [2 /*return*/];
        }
    });
}); };
export function subscribeForTxResult(fcl, txId, cb) {
    var unsub = fcl
        .tx(txId)
        .subscribe(function (transaction) {
        cb(__assign({ txId: txId }, transaction));
        if (fcl.tx.isSealed(transaction)) {
            unsub();
        }
    });
}
export var contractAddressHex = function (fcl, label) { return __awaiter(void 0, void 0, void 0, function () {
    var contract;
    return __generator(this, function (_a) {
        switch (_a.label) {
            case 0: return [4 /*yield*/, fcl.config().get(label)];
            case 1:
                contract = _a.sent();
                return [2 /*return*/, fcl.sansPrefix(contract)];
        }
    });
}); };
var templateObject_1;
